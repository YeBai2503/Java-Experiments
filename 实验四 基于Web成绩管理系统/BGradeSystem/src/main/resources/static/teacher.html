<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>åŒ—æ¸¯å¤§å­¦ | æ•™å¸ˆç«¯</title>
    <link rel="icon" type="image/jpg" href="video/logo.png" sizes="32x32">
    <link rel="stylesheet" href="css/normal.css">
</head>
<body>
<video autoplay muted loop>
    <source src="video/genish.mp4" type="video/mp4">  <!-- æ›¿æ¢ä¸ºæ‚¨çš„ MP4 æ–‡ä»¶è·¯å¾„ -->
    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾ã€‚
</video>
<div class="container">
    <h1 style="text-align: center;">åŒ—æ¸¯å¤§å­¦æˆç»©ç®¡ç†ç³»ç»Ÿ----æ•™å¸ˆç«¯</h1>
    <h1 style="text-align: center;">æ¬¢è¿è€å¸ˆ <<span id="userName"></span>> !</h1>

    <h2 style="text-align: center;">ç­çº§æˆç»©å•</h2>
    <!-- æ’åºé€‰é¡¹ -->
    <div style="text-align: center; margin: 20px;">
        <button onclick="getGrade('id')" style="background-color: #8ff593">æŒ‰å­¦å·æ’åº</button>
        <button onclick="getGrade('grade')" style="background-color: #8ff593">æŒ‰æˆç»©æ’åº</button>
    </div>

    <div style="text-align: center; margin: 20px;">
        <button id="batchGenerateBtn" onclick="toggleBatchGenerate()" class="blue-button">æ‰¹é‡ç”Ÿæˆæˆç»©</button>
    </div>

    <div id="classInfo" style=" margin: 20px;">
        <p style="font-size: 1em;">
            <strong>ç­çº§ç¼–å·: </strong> <span id="searchClassId"></span>&nbsp;&nbsp;
            <strong>ç­çº§è¯¾ç¨‹: </strong> <span id="searchClassName"></span>&nbsp;&nbsp;
            <strong>å¼€è¯¾å­¦æœŸ: </strong> <span id="searchClassTerm"></span>&nbsp;&nbsp;
            <strong>ç­çº§æ€»äººæ•°:</strong> <span id="searchClassNumStudent"></span>
        </p>
    </div>
    <!-- å­¦ç”Ÿæˆç»©è¡¨æ ¼ -->
    <table id="gradesTable" border="1" style="width: 100%; margin-top: 20px; text-align: center;">
        <thead>
        <tr>
            <th>å­¦å·</th>
            <th>å§“å</th>
            <th>æ€§åˆ«</th>
            <th>ç­‰çº§</th>
            <th>å¹³æ—¶æˆç»©</th>
            <th>æœŸä¸­æˆç»©</th>
            <th>å®éªŒæˆç»©</th>
            <th>æœŸæœ«æˆç»©</th>
            <th>ç»¼åˆæˆç»©</th>
            <th>æ“ä½œ</th>  <!-- æ–°æ·»åŠ çš„æ“ä½œåˆ— -->
        </tr>
        </thead>
        <tbody id="gradesTableBody">
        <!-- è¡¨æ ¼å†…å®¹å°†é€šè¿‡ JavaScript å¡«å…… -->
        </tbody>
    </table>








    <!-- é€€å‡ºæŒ‰é’® -->
    <button onclick="window.location.href='login.html';" class="danger-button" style="display: block; margin: 0 auto;">
        é€€å‡º
    </button>

    <!-- æ³¨é”€è´¦æˆ·æŒ‰é’® -->
    <button id="deleteAccountBtn" class="danger-button" style="display: block; margin: 20px auto;">
        æ³¨é”€è´¦æˆ·
    </button>
</div>

<script>
    const userId = sessionStorage.getItem('BG_userId');
    var classId;
    console.log(userId); // åœ¨æ§åˆ¶å°æ‰“å°å‡º ID
    let grades=[];

    // å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥è·å–ç”¨æˆ·å
    function fetchUserName() {
        // æ£€æŸ¥ userId æ˜¯å¦å­˜åœ¨
        if (userId) {
            // å‘èµ· GET è¯·æ±‚
            fetch(`http://localhost:8080/selTeacherById/${userId}`)
                .then(response => {
                    // æ£€æŸ¥å“åº”æ˜¯å¦æˆåŠŸ
                    if (!response.ok) {
                        throw new Error('ç½‘ç»œå“åº”ä¸æ˜¯ OK');
                    }
                    return response.json();
                })
                .then(data => {
                    // æ£€æŸ¥è¿”å›çš„æ•°æ®æ˜¯å¦æœ‰æ•ˆ
                    if (data.code === 200) {
                        document.getElementById('userName').textContent = data.data.teacher.name;
                        document.getElementById('searchClassId').textContent = data.data.classroom.id;
                        document.getElementById('searchClassName').textContent = data.data.classroom.name;
                        document.getElementById('searchClassTerm').textContent = data.data.classroom.term;
                        document.getElementById('searchClassNumStudent').textContent = data.data.classroom.numStudent;


                    } else {
                        console.error('Error in response data:', data.message);
                    }
                })
                .catch(error => {
                    console.error('è·å–ç”¨æˆ·åæ—¶å‘ç”Ÿé”™è¯¯:', error);
                });
        } else {
            console.error('æœªæ‰¾åˆ° userId');
        }
    }
    fetchUserName();

    // å°†-1çš„åˆ†æ•°æ›¿æ¢ä¸ºâ€œæœªè€ƒâ€çš„å‡½æ•°
    function formatScore(score) {
        return score === -1 ? "æœªè€ƒ" : score;
    }
    function getGrade(sortType) {
        if (userId) {
            fetch(`http://localhost:8080/selTeacherById/${userId}`)
                .then(response => {
                    if (!response.ok) throw new Error('ç½‘ç»œå“åº”ä¸æ˜¯ OK');
                    return response.json();
                })
                .then(data => {
                    if (data.code === 200) {
                        classId = data.data.classroom.id;
                        fetchGrades(sortType);
                    } else {
                        console.error('Error in response data:', data.message);
                    }
                })
                .catch(error => {
                    console.error('è·å–ç­çº§IDæ—¶å‘ç”Ÿé”™è¯¯:', error);
                });
        } else {
            console.error('æœªæ‰¾åˆ° userId');
        }
    }

    function fetchGrades(sortType) {
        const url = sortType === 'id' ?
            `http://localhost:8080/idRankingClassGrade/${classId}` :
            `http://localhost:8080/gradeRankingClassGrade/${classId}`;

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('ç½‘ç»œå“åº”ä¸æ˜¯ OK');
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    grades = data.data;
                    populateGradesTable();
                    //populateGradesTable(data.data);
                } else {
                    console.error('Error in response data:', data.message);
                }
            })
            .catch(error => {
                console.error('è·å–æˆç»©åˆ—è¡¨æ—¶å‘ç”Ÿé”™è¯¯:', error);
            });
    }

    function populateGradesTable() {
        const tableBody = document.getElementById('gradesTableBody');
        tableBody.innerHTML = ''; // æ¸…ç©ºç°æœ‰è¡¨æ ¼å†…å®¹

        // åˆ›å»ºä¸€ä¸ªæ•°ç»„æ¥å­˜å‚¨æ‰€æœ‰çš„ Promise
        const promises = grades.map(item => {
            return fetch(`http://localhost:8080/selStudentById/${item.studentId}`)
                .then(response => {
                    if (!response.ok) throw new Error('ç½‘ç»œå“åº”ä¸æ˜¯ OK');
                    return response.json();
                })
                .then(data => {
                    if (data.code === 200) {
                        const student = data.data;
                        // è¿”å›ä¸€ä¸ªè¡Œçš„ HTML
                        return `
                        <tr data-student-id="${item.studentId}">
                            <td>${item.studentId}</td>
                            <td>${student.name}</td>
                            <td>${student.sex}</td>
                            <td>${student.level}</td>
                            <td>${formatScore(item.usualScore)}</td>
                            <td>${formatScore(item.middleScore)}</td>
                            <td>${formatScore(item.experimentScore)}</td>
                            <td>${formatScore(item.endScore)}</td>
                            <td>${formatScore(item.sumScore)}</td>
                            <td><button onclick="editGrade(this)"  class="modify-button">ä¿®æ”¹</button></td> <!-- ä¿®æ”¹æŒ‰é’® -->
                        </tr>
                    `;
                    } else {
                        console.error('Error in student data:', data.message);
                        return '';  // è¿”å›ç©ºå­—ç¬¦ä¸²ä»¥ä¿æŒæ•°ç»„é•¿åº¦ä¸€è‡´
                    }
                })
                .catch(error => {
                    console.error('è·å–å­¦ç”Ÿä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯:', error);
                    return '';  // è¿”å›ç©ºå­—ç¬¦ä¸²ä»¥ç¡®ä¿ä¸ä¼šä¸­æ–­å¤„ç†
                });
        });

        // ä½¿ç”¨ Promise.all ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ
        Promise.all(promises).then(rows => {
            // è¿‡æ»¤æ‰è¿”å›ç©ºå­—ç¬¦ä¸²çš„è¡Œ
            const filteredRows = rows.filter(row => row !== '');
            // å°†æ‰€æœ‰çš„è¡Œä¸€èµ·æ’å…¥åˆ°è¡¨æ ¼ä¸­
            tableBody.innerHTML = filteredRows.join('');
        });
    }
    getGrade('id');


    document.getElementById('deleteAccountBtn').addEventListener('click', function() {
        // ä½¿ç”¨ fetch API å‘é€ DELETE è¯·æ±‚
        if (confirm("æ‚¨ç¡®å®šè¦æ³¨é”€è´¦æˆ·å—ï¼ŸğŸ˜¢ğŸ˜¢")) {
            fetch(`http://localhost:8080/delTeacherById/${userId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        // æ³¨é”€æˆåŠŸåè·³è½¬åˆ° login.html
                        window.location.href = 'login.html';
                    } else {
                        // å¤„ç†é”™è¯¯
                        alert('æ³¨é”€è´¦æˆ·å¤±è´¥!');
                    }
                })
                .catch(error => {
                    console.error('å‡ºç°é”™è¯¯:', error);
                    alert('æ³¨é”€è´¦æˆ·æ—¶å‘ç”Ÿé”™è¯¯!');
                });
        }
    });


    // ç¼–è¾‘æˆç»©
    function editGrade(button) {
        const row = button.closest('tr');
        const studentId = row.getAttribute('data-student-id');
        const usualScore = row.cells[4].textContent.trim();
        const middleScore = row.cells[5].textContent.trim();
        const experimentScore = row.cells[6].textContent.trim();
        const endScore = row.cells[7].textContent.trim();

        row.cells[4].innerHTML = `<input type="number" min="1" max="100" style="width: 100px;" value="${usualScore}" />`;
        row.cells[5].innerHTML = `<input type="number" min="1" max="100" style="width: 100px;" value="${middleScore}" />`;
        row.cells[6].innerHTML = `<input type="number" min="1" max="100" style="width: 100px;" value="${experimentScore}" />`;
        row.cells[7].innerHTML = `<input type="number" min="1" max="100" style="width: 100px;" value="${endScore}" />`;
        button.textContent = "ç¡®å®š";  // æ›´æ”¹æŒ‰é’®æ–‡æœ¬
        button.setAttribute('onclick', 'confirmEdit(this, ' + studentId + ')'); // æ”¹å˜æŒ‰é’®çš„onclickäº‹ä»¶
    }

    // ç¡®è®¤ä¿®æ”¹
    function confirmEdit(button, studentId) {
        console.log("ç­å·"+classId)
        console.log("å­¦ç”Ÿ"+studentId)
        const row = button.closest('tr');
        const usualScore = row.cells[4].querySelector('input').value;
        const middleScore = row.cells[5].querySelector('input').value;
        const experimentScore = row.cells[6].querySelector('input').value;
        const endScore = row.cells[7].querySelector('input').value;

        // åˆ›å»º URLSearchParams å¯¹è±¡
        const params = new URLSearchParams();
        params.append('id', studentId);
        params.append('classId', classId);
        params.append('usualScore', usualScore);
        params.append('middleScore', middleScore);
        params.append('experimentScore', experimentScore);
        params.append('endScore', endScore);


        // æ‰§è¡Œ POST è¯·æ±‚
        fetch('http://localhost:8080/modifyGrade', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: params.toString()
        })
            .then(response => {
                if (!response.ok) throw new Error('ç½‘ç»œå“åº”ä¸æ˜¯ OK');
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    alert('ä¿®æ”¹æˆåŠŸï¼');
                    getGrade('id');
                } else {
                    alert('ä¿®æ”¹å¤±è´¥ï¼š' + data.message);
                }
            })
            .catch(error => {
                console.error('å‘ç”Ÿé”™è¯¯:', error);
            });

        // æ¢å¤æŒ‰é’®çŠ¶æ€
        button.textContent = "ä¿®æ”¹";
        button.setAttribute('onclick', 'editGrade(this)'); // æ¢å¤ç‚¹å‡»äº‹ä»¶
    }

    // åˆ‡æ¢æŒ‰é’®çŠ¶æ€çš„å‡½æ•°
    function toggleBatchGenerate() {
        const button = document.getElementById('batchGenerateBtn');

        // åˆ¤æ–­å½“å‰æŒ‰é’®çš„çŠ¶æ€
        if (button.textContent === 'æ‰¹é‡ç”Ÿæˆæˆç»©') {
            button.textContent = 'ç¡®å®š'; // æ”¹ä¸ºç¡®å®šçŠ¶æ€

            // æ˜¾ç¤ºå¤é€‰æ¡†å¹¶éšè—ä¿®æ”¹æŒ‰é’®
            const rows = document.querySelectorAll('#gradesTableBody tr');
            rows.forEach(row => {
                const studentId = row.getAttribute('data-student-id');
                // éšè—ä¿®æ”¹æŒ‰é’®å¹¶æ·»åŠ å¤é€‰æ¡†
                const modifyButton = row.querySelector('.modify-button');
                modifyButton.style.display = 'none'; // éšè—ä¿®æ”¹æŒ‰é’®
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'grade-checkbox';


                row.appendChild(checkbox); // æ·»åŠ å¤é€‰æ¡†åˆ°å½“å‰è¡Œ
                // å°†å¤é€‰æ¡†æ’å…¥åˆ°æ“ä½œæŒ‰é’®çš„å•å…ƒæ ¼
                const actionCell = modifyButton.parentElement; // è·å–æ“ä½œæŒ‰é’®çš„å•å…ƒæ ¼
                actionCell.innerHTML = ''; // æ¸…ç©ºå½“å‰å•å…ƒæ ¼å†…å®¹
                // è®¾ç½® CSS æ ·å¼ä»¥ç¡®ä¿å¤é€‰æ¡†å±…ä¸­
                actionCell.style.display = 'flex'; // ä½¿å•å…ƒæ ¼ä½¿ç”¨çµæ´»å¸ƒå±€
                actionCell.style.justifyContent = 'center'; // æ°´å¹³å±…ä¸­
                actionCell.style.alignItems = 'center'; // å‚ç›´å±…ä¸­
                actionCell.appendChild(checkbox); // æ·»åŠ å¤é€‰æ¡†


            });
        } else {
            // è·å–é€‰ä¸­çš„å­¦ç”Ÿ ID
            const selectedStudentIds = Array.from(document.querySelectorAll('.grade-checkbox:checked'))
                .map(checkbox => {
                    return checkbox.closest('tr').getAttribute('data-student-id'); // è·å–å­¦ç”ŸID
                });

            const classIdToSend = classId; // ä½¿ç”¨ç°æœ‰çš„ classId

            // è¿›è¡Œ POST è¯·æ±‚
            if (selectedStudentIds.length > 0) {
                // æ„å»º application/x-www-form-urlencoded æ ¼å¼çš„è¯·æ±‚ä½“
                const params = new URLSearchParams();
                params.append('classId', classIdToSend);
                selectedStudentIds.forEach(studentId => {
                    params.append('studentIds', studentId); // æ·»åŠ æ¯ä¸€ä¸ª studentId
                });

                fetch('http://localhost:8080/manyGradeAuto', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: params.toString() // å‘é€ URL ç¼–ç åçš„æ•°æ®
                })
                    .then(response => {
                        if (!response.ok) throw new Error('ç½‘ç»œå“åº”ä¸æ˜¯ OK');
                        return response.json();
                    })
                    .then(data => {
                        if (data.code === 200) {
                            alert('æˆç»©ç”ŸæˆæˆåŠŸï¼');
                            getGrade('id'); // åˆ·æ–°æˆç»©è¡¨
                        } else {
                            alert('ç”Ÿæˆæˆç»©å¤±è´¥: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('å‘ç”Ÿé”™è¯¯:', error);
                    });
            } else {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€åå­¦ç”Ÿã€‚');
                getGrade('id'); // åˆ·æ–°æˆç»©è¡¨
            }

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            button.textContent = 'æ‰¹é‡ç”Ÿæˆæˆç»©';

            // éšè—å¤é€‰æ¡†ï¼Œæ¢å¤ä¿®æ”¹æŒ‰é’®
            const rows = document.querySelectorAll('#gradesTableBody tr');
            rows.forEach(row => {
                // const checkbox = row.querySelector('.grade-checkbox');
                // if (checkbox) {
                //     checkbox.parentNode.removeChild(checkbox); // ç§»é™¤å¤é€‰æ¡†
                // }
                // const modifyButton = row.querySelector('.modify-button');
                // modifyButton.style.display = 'inline'; // æ¢å¤æ˜¾ç¤ºä¿®æ”¹æŒ‰é’®
                const actionCell = row.querySelector('td:last-child'); // é€‰æ‹©æ“ä½œåˆ—
                const checkbox = row.querySelector('.grade-checkbox');
                if (checkbox) {
                    checkbox.parentNode.removeChild(checkbox); // ç§»é™¤å¤é€‰æ¡†
                }
                const modifyButton = row.querySelector('.modify-button');
                modifyButton.style.display = 'inline'; // æ¢å¤æ˜¾ç¤ºä¿®æ”¹æŒ‰é’®
                actionCell.innerHTML = ''; // æ¸…ç©ºå½“å‰å•å…ƒæ ¼å†…å®¹
                actionCell.appendChild(modifyButton); // æ¢å¤ä¿®æ”¹æŒ‰é’®åˆ°æ“ä½œåˆ—
            });
        }
    }

</script>
</body>
</html>